#include <iostream>
#include <Windows.h>


int main()
{
    srand(time(NULL));
    setlocale(LC_ALL, "ru");

    HANDLE mutex;

    STARTUPINFO si;
    PROCESS_INFORMATION pi;

    wchar_t PATH[] = L"C:\\Users\\st310-05\\Desktop\\konkov_prakt12\\Printer\\x64\\Debug\\Client.exe";

    ZeroMemory(&si, sizeof(STARTUPINFO));
    si.cb = sizeof(STARTUPINFO);
    mutex = CreateMutex(NULL, FALSE, L"PrinterMutex");
    if (mutex == NULL) {
        return GetLastError();
    }
    
    std::cout << "Принтер активен" << std::endl;
    std::cout << "1. Запустить печать" << std::endl;
    char user;
    while (true) {
        std::cin >> user;
        if (user == '1') {
            if (!CreateProcess(PATH, NULL, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi)) {
                std::cout << "Ошибка" << std::endl;
            }
            if (WaitForSingleObject(mutex, 600000) == WAIT_OBJECT_0) {
                std::cout << "Печать" << std::endl;
                int time = (rand() % 15) * 1000;
                if (time >= 10000) {
                    std::cout << "Ошибка печати" << std::endl;
                }
                else {
                    Sleep(time);
                }
                ReleaseMutex(mutex);
                std::cout << "Готово" << std::endl;
            }
            else {
                std::cout << "Принтер выключается" << std::endl;
                break;
            }

            WaitForSingleObject(pi.hProcess, INFINITE);
            WaitForSingleObject(pi.hThread, INFINITE);
            CloseHandle(pi.hProcess);
            CloseHandle(pi.hThread);
        }
        else {
            std::cout << "Не верно выбранное действие";
        }
    }

    CloseHandle(mutex);

}
