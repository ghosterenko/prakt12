#include <iostream>
#include <Windows.h>

HANDLE mutex, printer;
DWORD IDT;

STARTUPINFO si;
PROCESS_INFORMATION pi;

wchar_t PATH[] = L"C:\\файлы\\c++\\prakt12\\Client\\x64\\Debug\\.exe";

void menu() {
    std::cout << "1. Печать - Высокий приоритет" << std::endl;
    std::cout << "2. Печать - Нормальный приоритет" << std::endl;
    std::cout << "1. Печать - Низкий приоритет" << std::endl;
}

DWORD WINAPI threadPrinter() {
    menu();
    while (true) {
        char v;
        std::cin >> v;
        switch (v) {
        case '1':
            ZeroMemory(&si, sizeof(STARTUPINFO));   
            si.cb = sizeof(STARTUPINFO);
            if (!CreateProcess(PATH, NULL, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi)) {
                return GetLastError();
            }
            
            if (WaitForSingleObject(mutex, 600000) == WAIT_OBJECT_0) {

            }
            else {

            }

            WaitForSingleObject(pi.hProcess, INFINITE);
            CloseHandle(pi.hProcess);
            CloseHandle(pi.hThread);

            break;
        case '2':
            ZeroMemory(&si, sizeof(STARTUPINFO));
            si.cb = sizeof(STARTUPINFO);
            if (!CreateProcess(PATH, NULL, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi)) {
                return GetLastError();
            }

            std::cout << "Задание отправлено на печать" << std::endl;
            break;
        case '3':
            ZeroMemory(&si, sizeof(STARTUPINFO));
            si.cb = sizeof(STARTUPINFO);
            if (!CreateProcess(PATH, NULL, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi)) {
                return GetLastError();
            }

            std::cout << "Задание отправлено на печать" << std::endl;
            break;
        default:
            std::cout << "Ошибка" << std::endl;
            break;
        }
    }
}

int main()
{
    srand(time(NULL));
    setlocale(LC_ALL, "ru");
    
    std::cout << "Принтер активен" << std::endl;
    mutex = CreateMutex(NULL, FALSE, L"PrinterMutex");
    if (mutex != NULL) {
        return GetLastError();
    }
    WaitForSingleObject(mutex, INFINITE);
    printer = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)threadPrinter, NULL, NULL, &IDT);
    if (printer != NULL) {
        return GetLastError();
    }
    WaitForSingleObject(printer, INFINITE);
    CloseHandle(mutex);
    CloseHandle(printer);

}

